<%# Replace the active items list to maintain correct sort_order %>
<%= turbo_stream.update "list-items" do %>
  <% @list.list_items.includes(:item).joins(:item).where(ticked: false).order('items.sort_order').each do |list_item| %>
    <%= render partial: "list_items/list_item", locals: { list_item: list_item } %>
  <% end %>
<% end %>

<%# Reset the add item sheet form %>
<%= turbo_stream.update "add-item-sheet-form" do %>
  <%= form_with model: [@list, Item.new], class: "sheet-form", data: { controller: "autocomplete", autocomplete_url_value: search_items_path, action: "click@window->autocomplete#clickOutside" } do |form| %>
    <div class="sheet-field">
      <label class="sheet-label" for="sheet_item_name">Item name</label>
      <%= form.text_field "name", data: { autocomplete_target: "input", action: "input->autocomplete#search keydown->autocomplete#keydown" }, autocomplete: "off", name: "item[name_#{SecureRandom.hex(4)}]", id: "sheet_item_name", class: "sheet-input", placeholder: "What do you need?", autofocus: true %>
      <%= form.hidden_field "name", id: "sheet_item_name_hidden" %>
      <div data-autocomplete-target="results" class="autocomplete-results"></div>
    </div>
    <div class="sheet-field">
      <label class="sheet-label">Quantity</label>
      <div class="quantity-stepper" data-controller="quantity-stepper">
        <button type="button" class="stepper-btn" data-action="click->quantity-stepper#decrement" aria-label="Decrease quantity">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="14" y2="9"/></svg>
        </button>
        <span class="stepper-value" data-quantity-stepper-target="display">1</span>
        <%= form.number_field "quantity", min: 1, value: 1, class: "stepper-hidden-input", data: { quantity_stepper_target: "input" } %>
        <button type="button" class="stepper-btn" data-action="click->quantity-stepper#increment" aria-label="Increase quantity">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="14" y2="9"/><line x1="9" y1="4" x2="9" y2="14"/></svg>
        </button>
      </div>
    </div>
    <%= form.hidden_field "group_id", value: @list.group_id %>
    <button type="submit" class="sheet-submit-btn">Add to List</button>
  <% end %>
<% end %>

<%# Also update the hidden inline form %>
<%= turbo_stream.update "new_item" do %>
  <%= form_with model: [@list, Item.new], class: "add-item-form" do |form| %>
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
      <div style="flex: 1; position: relative;" data-controller="autocomplete" data-autocomplete-url-value="<%= search_items_path %>" data-action="click@window->autocomplete#clickOutside">
        <%= form.label "Item name" %>
        <%= form.text_field "name", data: { autocomplete_target: "input", action: "input->autocomplete#search keydown->autocomplete#keydown" }, autocomplete: "off", name: "item[name_#{SecureRandom.hex(4)}]", id: "item_name_field" %>
        <%= form.hidden_field "name", id: "item_name_hidden" %>
        <div data-autocomplete-target="results" class="autocomplete-results"></div>
      </div>
      <div style="width: 150px;">
        <%= form.label "Quantity" %>
        <%= form.number_field "quantity", min: 1, value: 1 %>
      </div>
    </div>
    <%= form.hidden_field "group_id", value: @list.group_id %>
    <%= form.submit "Add item", class: "button" %>
  <% end %>
<% end %>
