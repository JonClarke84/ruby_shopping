<% if @list %>
  <% content_for :title, "Current List for #{@list.date}" %>

  <h1>Shopping list for <%= @list.date.strftime('%A %d %B') %></h1>

  <details class="card" id="list-meals">
    <summary class="card-header">
      <h2>Meals</h2>
    </summary>
    <div class="card-content">
      <%= form_with( url: list_meals_path(@list), method: :patch, local: true ) do |form| %>
        <% 7.times do |n| %>
          <% date = @list.date + n.days %>
          <% meal = @list.meal_for_date(date) %>
          <div class="field">
            <%= form.label date.strftime('%A') %>
            <%= form.text_field "meals[#{date}]", value: meal&.name %>
          </div>
        <% end %>
        <%= form.hidden_field "group_id", value: @list.group_id %>
        <div style="margin-top: 1rem;">
          <%= form.submit "Update Meals", class: "button" %>
        </div>
      <% end %>
    </div>
  </details>


  <div class="card" id="list-items-section">
    <div class="card-header">
      <h2>Items</h2>
    </div>
    <div id="new_item">
      <%= form_with model: [@list, @item], class: "add-item-form" do |form| %>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
          <div style="flex: 1; position: relative;" data-controller="autocomplete" data-autocomplete-url-value="<%= search_items_path %>" data-action="click@window->autocomplete#clickOutside">
            <%= form.label "Item name" %>
            <%= form.text_field "name", data: { autocomplete_target: "input", action: "input->autocomplete#search keydown->autocomplete#keydown" }, autocomplete: "off", name: "item[name_#{SecureRandom.hex(4)}]", id: "item_name_field", required: true, placeholder: "Enter item name" %>
            <%= form.hidden_field "name", id: "item_name_hidden", required: true %>
            <div data-autocomplete-target="results" class="autocomplete-results"></div>
          </div>
          <div style="width: 150px;">
            <%= form.label "Quantity" %>
            <%= form.number_field "quantity", min: 1, value: 1 %>
          </div>
        </div>
        <%= form.hidden_field "group_id", value: @list.group_id %>
        <%= form.submit "Add item", class: "button" %>
      <% end %>
    </div>

    <% if @list.items.any? %>
      <div id="list-items" class="list-items-grid" style="margin-top: 1.5rem;" data-controller="list-items">
        <% @list.list_items.includes(:item).joins(:item).order('items.sort_order').each do |list_item| %>
          <%= render partial: "list_items/list_item", locals: { list_item: list_item } %>
        <% end %>
      </div>
    <% end %>
  </div>
<% else %>
  <% content_for :title, "No Lists Yet" %>

  <h1>No lists yet for this group</h1>
  <p><%= link_to "Create your first list", new_list_path %></p>
<% end %>
