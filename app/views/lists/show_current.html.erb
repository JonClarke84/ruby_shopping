<% if @list %>
  <% content_for :title, "Shopping List" %>
  <% content_for :list_subtitle, "#{@list.date.strftime('%-d %b')} â€“ #{@list.end_date.strftime('%-d %b')}" %>

  <% content_for :fab_and_sheet do %>
    <div data-controller="add-item-sheet">
      <%# FAB Button %>
      <button class="fab" data-action="click->add-item-sheet#open" aria-label="Add item">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>

      <%# Backdrop %>
      <div class="sheet-backdrop" data-add-item-sheet-target="backdrop" data-action="click->add-item-sheet#backdropClick"></div>

      <%# Bottom Sheet %>
      <div class="bottom-sheet" data-add-item-sheet-target="sheet">
        <div class="sheet-drag-handle" data-add-item-sheet-target="dragHandle" data-action="pointerdown->add-item-sheet#dragStart"></div>
        <h2 class="sheet-title">Add Item</h2>

        <div id="add-item-sheet-form" data-action="turbo:submit-end->add-item-sheet#resetForm">
          <%= form_with model: [@list, Item.new], class: "sheet-form", data: { controller: "autocomplete", autocomplete_url_value: search_items_path, action: "click@window->autocomplete#clickOutside" } do |form| %>
            <div class="sheet-field">
              <label class="sheet-label" for="sheet_item_name">Item name</label>
              <%= form.text_field "name", data: { autocomplete_target: "input", add_item_sheet_target: "nameInput", action: "input->autocomplete#search keydown->autocomplete#keydown" }, autocomplete: "off", name: "item[name_#{SecureRandom.hex(4)}]", id: "sheet_item_name", class: "sheet-input", placeholder: "What do you need?" %>
              <%= form.hidden_field "name", id: "sheet_item_name_hidden", data: { add_item_sheet_target: "hiddenName" } %>
              <div data-autocomplete-target="results" class="autocomplete-results"></div>
            </div>
            <div class="sheet-field">
              <label class="sheet-label">Quantity</label>
              <div class="quantity-stepper" data-controller="quantity-stepper">
                <button type="button" class="stepper-btn" data-action="click->quantity-stepper#decrement" aria-label="Decrease quantity">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="14" y2="9"/></svg>
                </button>
                <span class="stepper-value font-mono" data-quantity-stepper-target="display" data-add-item-sheet-target="quantityDisplay">1</span>
                <%= form.number_field "quantity", min: 1, value: 1, class: "stepper-hidden-input", data: { quantity_stepper_target: "input", add_item_sheet_target: "quantityInput" } %>
                <button type="button" class="stepper-btn" data-action="click->quantity-stepper#increment" aria-label="Increase quantity">
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="14" y2="9"/><line x1="9" y1="4" x2="9" y2="14"/></svg>
                </button>
              </div>
            </div>
            <%= form.hidden_field "group_id", value: @list.group_id %>
            <button type="submit" class="sheet-submit-btn">Add to List</button>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div id="list-items-section">
    <div id="new_item" class="hidden">
      <%= form_with model: [@list, @item], class: "add-item-form" do |form| %>
        <div class="flex gap-2 mb-2">
          <div class="form-field" style="flex: 1; position: relative;" data-controller="autocomplete" data-autocomplete-url-value="<%= search_items_path %>" data-action="click@window->autocomplete#clickOutside">
            <%= form.label "Item name" %>
            <%= form.text_field "name", data: { autocomplete_target: "input", action: "input->autocomplete#search keydown->autocomplete#keydown" }, autocomplete: "off", name: "item[name_#{SecureRandom.hex(4)}]", id: "item_name_field", required: true, placeholder: "Enter item name" %>
            <%= form.hidden_field "name", id: "item_name_hidden", required: true %>
            <div data-autocomplete-target="results" class="autocomplete-results"></div>
          </div>
          <div class="form-field" style="width: 100px;">
            <%= form.label "Qty" %>
            <%= form.number_field "quantity", min: 1, value: 1 %>
          </div>
        </div>
        <%= form.hidden_field "group_id", value: @list.group_id %>
        <%= form.submit "Add item", class: "button button-block" %>
      <% end %>
    </div>

    <% unticked_items = @list.list_items.includes(:item).joins(:item).where(ticked: false).order('items.sort_order') %>
    <% ticked_items = @list.list_items.includes(:item).joins(:item).where(ticked: true).order('items.sort_order') %>

    <div id="list-items" class="list-items-grid" data-controller="list-items">
      <% unticked_items.each do |list_item| %>
        <%= render partial: "list_items/list_item", locals: { list_item: list_item } %>
      <% end %>
    </div>

    <% if ticked_items.any? %>
      <details class="completed-section" id="completed-items">
        <summary class="completed-header">
          Completed (<%= ticked_items.count %>)
        </summary>
        <div class="completed-items-list">
          <% ticked_items.each do |list_item| %>
            <%= render partial: "list_items/list_item", locals: { list_item: list_item } %>
          <% end %>
        </div>
      </details>
    <% end %>
  </div>
<% else %>
  <% content_for :title, "Shopping List" %>

  <div class="empty-state">
    <div class="empty-state-icon">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/>
        <rect x="9" y="3" width="6" height="4" rx="1"/>
      </svg>
    </div>
    <p class="empty-state-title">No lists yet</p>
    <p class="empty-state-text">Create your first shopping list to get started</p>
    <%= link_to "Create your first list", new_list_path, class: "button" %>
  </div>
<% end %>
